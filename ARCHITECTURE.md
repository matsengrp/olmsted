# Olmsted Web Application Architecture

## Table of Contents

- [Overview](#overview)
- [Data Flow Architecture](#data-flow-architecture)
- [Redux Store Structure](#redux-store-structure)
- [Component Hierarchy](#component-hierarchy)
- [Visualization System](#visualization-system)
- [Key Files Reference](#key-files-reference)
- [IndexedDB Schema](#indexeddb-schema)

---

## Overview

Olmsted is a client-side B-cell lineage visualization tool for exploring immunological repertoire data. The application processes Olmsted JSON files (generated by olmsted-cli from AIRR/PCP formats) and provides interactive visualizations of clonal families, phylogenetic trees, and sequence alignments.

### Technology Stack

- **React 18** - UI component framework with class components and decorators
- **Redux** - State management with thunk middleware for async operations
- **Vega 5** - Declarative visualization grammar for interactive plots
- **Dexie (IndexedDB)** - Client-side persistent storage for large datasets
- **D3** - Data manipulation and supplementary visualizations

### High-Level Architecture

```
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|   File Upload    |---->|  FileProcessor   |---->|   IndexedDB      |
|   (Drag & Drop)  |     |  (Parse JSON)    |     |   (Dexie)        |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +--------+---------+
                                                          |
                                                          v
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|   Vega Charts    |<----|  React           |<----|  Redux Store     |
|   (Scatterplot,  |     |  Components      |     |  (State Mgmt)    |
|    Tree, etc.)   |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
```

---

## Data Flow Architecture

### Complete Data Flow Diagram

```
                            USER INTERACTION
                                   |
                                   v
+-------------------------------------------------------------------+
|                         FILE UPLOAD LAYER                         |
|                                                                   |
|  FileUpload.js          FileProcessor.js       splitFileProcessor |
|  (Drag & Drop)    --->  (Parse JSON)      ---> (Large files)      |
|                                                                   |
+-------------------------------------------------------------------+
                                   |
                                   v
+-------------------------------------------------------------------+
|                         STORAGE LAYER                             |
|                                                                   |
|  olmstedDB.js (Dexie)              clientDataStore.js             |
|  +------------------+              +------------------------+     |
|  | datasets         |              | LRU Memory Cache       |     |
|  | clones           |<------------>| (10 items max)         |     |
|  | trees            |              | - recentClones Map     |     |
|  | configs          |              | - recentTrees Map      |     |
|  +------------------+              +------------------------+     |
|                                                                   |
+-------------------------------------------------------------------+
                                   |
                                   v
+-------------------------------------------------------------------+
|                         REDUX LAYER                               |
|                                                                   |
|  Actions (clientDataLoader.js)     Middleware                     |
|  - getClientDatasets()             - changeURLMiddleware          |
|  - getClientClonalFamilies()       - thunk (async)                |
|  - getClientTree()                                                |
|                                           |                       |
|                                           v                       |
|                                    Redux Store                    |
|                               (5 combined reducers)               |
|                                                                   |
+-------------------------------------------------------------------+
                                   |
                                   v
+-------------------------------------------------------------------+
|                       PRESENTATION LAYER                          |
|                                                                   |
|  Selectors (Reselect)          React Components                   |
|  - getAvailableClonalFamilies  +---------------------------+      |
|  - getBrushedClonalFamilies    | Root                      |      |
|  - getSelectedFamily           |   NavBar                  |      |
|  - getClonalFamiliesPage       |   MainComponentSwitch     |      |
|                                |     Splash / App          |      |
|                                +---------------------------+      |
|                                           |                       |
|                                           v                       |
|                                    Vega Visualizations            |
|                               (facetScatterPlot, tree, etc.)      |
|                                                                   |
+-------------------------------------------------------------------+
```

### Upload & Processing Pipeline

1. **File Upload** (`src/components/splash/fileUpload.js`)
   - Accepts drag-and-drop or file browser selection
   - Validates file is Olmsted JSON format (generated by olmsted-cli)
   - Triggers processing pipeline

2. **File Processing** (`src/utils/fileProcessor.js`)
   - Parses consolidated JSON format
   - Validates required structure: `metadata`, `datasets`, `clones`, `trees`
   - Generates unique dataset IDs for client-side storage
   - Converts node arrays to indexed objects for efficient lookup

3. **Storage** (`src/utils/clientDataStore.js`)
   - Stores processed data in IndexedDB via Dexie
   - Implements LRU memory cache (10 items) for frequently accessed data
   - Separates lightweight metadata from heavy tree data for lazy loading

### Data Loading Strategy

The application uses a **lazy loading** strategy to handle large datasets:

1. **Datasets** - Always loaded (lightweight metadata)
2. **Clone metadata** - Loaded when dataset is selected (no sequence data)
3. **Tree data** - Loaded on-demand when user selects a specific family

```javascript
// src/actions/clientDataLoader.js

// Load lightweight clone metadata (fast)
getClientClonalFamilies(dispatch, dataset_id);

// Load full tree with sequences (on-demand)
getClientTree(dispatch, tree_id);
```

---

## Redux Store Structure

### Root State Shape

```javascript
{
  browserDimensions: { ... },
  datasets: { ... },
  clonalFamilies: { ... },
  trees: { ... },
  configs: { ... }
}
```

### Reducer Details

#### `browserDimensions` (src/reducers/browserDimensions.js)

Tracks window dimensions for responsive layout:

```javascript
{
  browserDimensions: {
    width: number,      // window.innerWidth
    height: number,     // window.innerHeight
    docHeight: number   // document.body.clientHeight
  }
}
```

#### `datasets` (src/reducers/datasets.js)

Manages dataset metadata and application routing:

```javascript
{
  s3bucket: string,                  // Legacy: "live"
  availableDatasets: [               // Array of dataset objects
    {
      dataset_id: string,
      name: string,
      clone_count: number,
      isClientSide: boolean,
      loading: "LOADING" | "DONE" | "ERROR" | undefined,
      ...metadata
    }
  ],
  selectedDatasets: string[],        // Dataset IDs selected for batch loading
  pendingDatasetLoads: string[],     // Dataset IDs pending from URL query
  starredDatasets: string[],         // Favorited dataset IDs
  displayComponent: "splash" | "app", // Current page/view
  urlPath: string,                   // Current URL pathname
  urlQuery: string,                  // Current URL search string
  errorMessage: string | undefined
}
```

#### `clonalFamilies` (src/reducers/clonalFamilies.js)

Core state for clonal family data and visualization settings:

```javascript
{
  // Data indices (two access patterns)
  byDatasetId: {                     // Primary index by dataset
    [dataset_id]: ClonalFamily[]
  },
  byIdent: {                         // Secondary index by identifier
    [ident]: ClonalFamily
  },

  // Selection state
  brushSelecting: boolean,
  brushSelection: {
    x: { fieldName: string, range: [number, number] },
    y: { fieldName: string, range: [number, number] },
    filter: { fieldName: string, range: any },
    clicked: string | false          // Family ident if clicked
  } | undefined,
  selectedFamily: string | undefined, // Currently selected family ident
  selectedSeq: object,               // Currently selected sequence

  // Pagination
  pagination: {
    page: number,                    // Current page (0-indexed)
    per_page: number,                // Items per page (default: 10)
    order_by: string,                // Sort column
    desc: boolean                    // Sort direction
  },

  // Visualization options
  facetByField: string,              // Faceting field (default: "none")
  locus: string,                     // Locus filter (default: "All")
  selectedChain: "heavy" | "light" | "both",
  lastClickedChain: "heavy" | "light",

  // Lineage visualization settings
  lineageShowEntire: boolean,
  lineageShowBorders: boolean,
  lineageChain: "heavy" | "light",

  // UI state
  currentSection: string,            // Current visible section for nav
  starredFamilies: string[],         // Starred/pinned family idents
  filters: {                         // High-level filters
    [fieldName]: string[]            // Selected values per field
  }
}
```

#### `trees` (src/reducers/trees.js)

Manages loaded tree data with caching:

```javascript
{
  selectedTreeIdent: string | undefined,  // Currently selected tree
  cache: {                                // Loaded tree objects
    [tree_id]: {
      tree_id: string,
      ident: string,
      clone_id: string,
      nodes: Node[],                      // Array of tree nodes
      root_node: string,
      newick: string,
      ...metadata
    } | { error: string }                 // Error state
  }
}
```

#### `configs` (src/reducers/configs.js)

Manages saved visualization configurations:

```javascript
{
  savedConfigs: [                    // Array of saved configs
    {
      id: string,
      name: string,
      datasetId: string | null,
      settings: object,
      createdAt: number,
      updatedAt: number
    }
  ],
  activeConfigId: string | null,     // Currently applied config
  isModalOpen: boolean,              // Config modal visibility
  isLoading: boolean,                // Async operation state
  error: string | null               // Error message
}
```

### Middleware

#### `changeURLMiddleware` (src/middleware/changeURL.js)

Synchronizes Redux state with browser URL:

- Intercepts actions that affect URL state
- Updates `window.history` (pushState/replaceState)
- Handles query string parsing/serialization
- Enables deep linking and browser navigation

#### `redux-thunk`

Enables async action creators for data loading operations.

---

## Component Hierarchy

### Component Tree

```
Root (src/Root.js)
|
+-- Monitor                          # Browser dimension tracking
|
+-- NavBarWrapper                    # Navigation bar container
|   +-- NavBar                       # Header with logo, section links, settings
|       +-- ConfigButton             # Settings menu access
|
+-- MainComponentSwitch              # Route-based view switching
    |
    +-- [displayComponent === "splash"]
    |   |
    |   +-- Splash                   # Landing page
    |       +-- DatasetManagementTable  # Dataset list with actions
    |       +-- FileUpload           # Drag-and-drop upload zone
    |
    +-- [displayComponent === "app"]
        |
        +-- App                      # Main exploration view
            |
            +-- VegaViewProvider     # Context for Vega view refs
            |
            +-- ConfigModal          # Saved configs modal
            |
            +-- CollapsibleSection: "Datasets"
            |   +-- DatasetLoadingTable  # Dataset selection for loading
            |
            +-- CollapsibleSection: "Clonal Families"
            |   +-- FilterPanel      # High-level filters (locus, subject, etc.)
            |   +-- SelectedFamiliesSummary  # Count display
            |   +-- ClonalFamiliesViz  # Vega scatterplot wrapper
            |       +-- facetScatterPlot  # Vega spec
            |
            +-- CollapsibleSection: "Selected Clonal Families"
            |   +-- ClonalFamiliesTable  # Paginated table
            |       +-- ResizableTable   # Column resize support
            |       +-- RowInfoModal     # Metadata viewer
            |
            +-- CollapsibleSection: "Clonal Family Details" [conditional]
            |   +-- TreeViz          # Tree visualization wrapper
            |       +-- clonalFamilyDetails  # Vega tree + alignment spec
            |
            +-- CollapsibleSection: "Ancestral Sequences" [conditional]
                +-- Lineage          # Ancestral sequence visualization
```

### Redux-Connected Components

The following components are connected to the Redux store:

| Component                 | Connected State                                                                                              |
| ------------------------- | ------------------------------------------------------------------------------------------------------------ |
| `App`                     | browserDimensions, availableDatasets, pendingDatasetLoads, selectedFamily, selectedSeq, loadedClonalFamilies |
| `Splash`                  | availableDatasets, errorMessage                                                                              |
| `MainComponentSwitch`     | displayComponent                                                                                             |
| `NavBarWrapper`           | displayComponent                                                                                             |
| `SelectedFamiliesSummary` | selectedFamily, nClonalFamiliesBrushed, nClonalFamiliesTotal                                                 |
| `ClonalFamiliesTable`     | clonalFamiliesPage, pagination, lastPage, selectedFamily, starredFamilies                                    |
| `ClonalFamiliesViz`       | availableClonalFamilies, brushSelection, availableDatasets, selectedChain                                    |
| `TreeViz`                 | selectedFamily, pairedClone, trees.cache, selectedTreeIdent                                                  |
| `Lineage`                 | selectedSeq, selectedFamily, lineage settings                                                                |
| `FilterPanel`             | filters, availableClonalFamilies, datasets                                                                   |
| `DatasetLoadingTable`     | datasets, selectedDatasets                                                                                   |
| `DatasetManagementTable`  | availableDatasets, starredDatasets                                                                           |
| `ConfigModal`             | configs state                                                                                                |
| `ConfigList`              | savedConfigs                                                                                                 |
| `ConfigButton`            | isModalOpen                                                                                                  |

---

## Visualization System

### Vega Integration

Olmsted uses Vega 5 for declarative, interactive visualizations. Vega specs are defined as JavaScript objects and rendered via `vega-embed`.

#### Key Visualization Components

| File                                                  | Purpose                                                                       |
| ----------------------------------------------------- | ----------------------------------------------------------------------------- |
| `src/components/explorer/vega/facetScatterPlot.js`    | Main clonal families scatterplot with brush selection, faceting, and zoom/pan |
| `src/components/explorer/vega/clonalFamilyDetails.js` | Combined phylogenetic tree and sequence alignment view                        |
| `src/components/explorer/vega/naive.js`               | V(D)J gene segment visualization for naive sequences                          |

#### Scatterplot Features (`facetScatterPlot.js`)

- **Axes**: Configurable X/Y mapping to continuous variables
- **Visual encodings**: Size, color, and shape by categorical/continuous variables
- **Faceting**: Split plot by categorical variable
- **Interaction modes**:
  - Select mode: Click/brush to select clonal families
  - Pan/Zoom mode: Navigate large datasets
  - Shift key: Temporarily toggle mode
- **Export**: PNG/SVG download support

#### Tree Visualization (`clonalFamilyDetails.js`)

- **Phylogenetic tree**: Hierarchical node layout with branch lengths
- **Sequence alignment**: Position-by-position view with mutation highlighting
- **Node tooltips**: Display LBI, LBR, multiplicity, and other metrics
- **Interactive selection**: Click nodes to view ancestral sequences

### VegaViewContext

The `VegaViewContext` (src/components/config/VegaViewContext.js) provides React context for accessing Vega view instances, enabling:

- Programmatic export (PNG/SVG)
- State synchronization with saved configs
- External control of Vega signals

---

## Key Files Reference

### Core Application

| File                 | Purpose                                         |
| -------------------- | ----------------------------------------------- |
| `src/index.js`       | Application entry point, React 18 root creation |
| `src/Root.js`        | Root component with routing logic               |
| `src/store/index.js` | Redux store configuration with middleware       |

### State Management

| File                                | Purpose                                    |
| ----------------------------------- | ------------------------------------------ |
| `src/reducers/index.js`             | Root reducer combining all reducers        |
| `src/reducers/datasets.js`          | Dataset metadata and routing state         |
| `src/reducers/clonalFamilies.js`    | Clonal family data and visualization state |
| `src/reducers/trees.js`             | Tree data cache                            |
| `src/reducers/configs.js`           | Saved visualization configs                |
| `src/reducers/browserDimensions.js` | Window dimensions                          |

### Data Management

| File                              | Purpose                                     |
| --------------------------------- | ------------------------------------------- |
| `src/utils/olmstedDB.js`          | Dexie database schema and CRUD operations   |
| `src/utils/clientDataStore.js`    | Storage abstraction with LRU caching        |
| `src/utils/fileProcessor.js`      | File parsing for Olmsted JSON format        |
| `src/actions/clientDataLoader.js` | Redux actions for loading data from storage |

### Middleware

| File                          | Purpose                        |
| ----------------------------- | ------------------------------ |
| `src/middleware/changeURL.js` | URL synchronization middleware |

### Selectors

| File                              | Purpose                                        |
| --------------------------------- | ---------------------------------------------- |
| `src/selectors/clonalFamilies.js` | Memoized selectors for filtered/paginated data |
| `src/selectors/trees.js`          | Tree data selectors                            |

### Main Components

| File                                  | Purpose                                               |
| ------------------------------------- | ----------------------------------------------------- |
| `src/components/splash/index.js`      | Landing page with upload and dataset management       |
| `src/components/explorer/app.js`      | Main exploration view with all visualization sections |
| `src/components/framework/nav-bar.js` | Navigation header                                     |

### Visualization Components

| File                                     | Purpose                          |
| ---------------------------------------- | -------------------------------- |
| `src/components/explorer/scatterplot.js` | Scatterplot wrapper component    |
| `src/components/explorer/tree.js`        | Tree visualization wrapper       |
| `src/components/explorer/lineage.js`     | Ancestral sequence visualization |
| `src/components/explorer/table.js`       | Clonal families table            |
| `src/components/explorer/FilterPanel.js` | High-level filter controls       |

### Vega Specifications

| File                                                  | Purpose                          |
| ----------------------------------------------------- | -------------------------------- |
| `src/components/explorer/vega/facetScatterPlot.js`    | Clonal families scatterplot spec |
| `src/components/explorer/vega/clonalFamilyDetails.js` | Tree + alignment spec            |
| `src/components/explorer/vega/naive.js`               | V(D)J segment visualization spec |

---

## IndexedDB Schema

The application uses Dexie.js to manage IndexedDB storage with the following schema:

### Database: `OlmstedClientStorage`

#### Version 2 Schema

```javascript
{
  // Dataset metadata (always loaded)
  datasets: "dataset_id, name, clone_count",

  // Clone family metadata (lightweight, loaded for lists)
  clones: "[dataset_id+clone_id], dataset_id, sample_id, name, unique_seqs_count, mean_mut_freq",

  // Complete tree data (heavy, loaded on demand per family)
  trees: "ident, tree_id, clone_id",

  // Visualization configs (user-saved settings)
  configs: "id, name, datasetId, createdAt"
}
```

#### Table Descriptions

| Table      | Primary Key             | Purpose                                           |
| ---------- | ----------------------- | ------------------------------------------------- |
| `datasets` | `dataset_id`            | Dataset metadata (name, clone count, upload time) |
| `clones`   | `[dataset_id+clone_id]` | Clone family metadata without heavy tree data     |
| `trees`    | `ident`                 | Full phylogenetic tree data with all nodes        |
| `configs`  | `id`                    | User-saved visualization configurations           |

#### Data Flow

1. **Upload**: Entire dataset stored via `olmstedDB.storeDataset()`
2. **Browse**: Clone metadata loaded via `olmstedDB.getCloneMetadata()`
3. **Visualize**: Full tree loaded on-demand via `olmstedDB.getTreeByIdent()`

This lazy loading approach enables handling datasets with thousands of clonal families while maintaining responsive UI performance.

---

_Last updated: 2026-01-23_
